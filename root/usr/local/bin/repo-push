#!/usr/bin/env bash

set -eu

source /etc/profile.d/getup.sh

info Switching to $REPO_DIR
cd $REPO_DIR

#git_cache_config=$(git config --global credential.https://github.com.helper)
#if [ "$git_cache_config" != "cache --timeout=3600" ]; then
#    info "Configuring git credentials cache (1h)"
#    git config --global credential.https://github.com.helper "cache --timeout=3600"
#fi

if ! has_remote upstream 2>/dev/null; then
    info "Local repository has no upstream remote"
    ask_execute_command repo-setup
fi

save_opt u
set +u
git_user_name=$(git config --get user.name || true)
git_user_email=$(git config --get user.email || true)

if [ -z "$git_user_name" ]; then
    read_config git_user_name "Your git user.name"
    git config --global user.name "$git_user_name"
fi

if [ -z "$git_user_email" ]; then
    read_config git_user_email "Your git user.email"
    git config --global user.email "$git_user_email"
fi
load_opt u

if ask_execute_command git status --short clusters/$name/$type; then
info "$(cat <<.

M = modified  A = added   D = deleted
R = renamed   C = copied  U = updated but unmerged
.
)"
fi

ask_execute_command git add repo.conf clusters/$name/$type
ask_execute_command git commit clusters/$name/$type -m "Automatic commit: clusters/$name/$type"
ask_execute_command git push origin main
