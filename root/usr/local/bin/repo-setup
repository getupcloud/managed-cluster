#!/usr/bin/env bash

set -eu

source /etc/profile.d/getup.sh

info Switching to $REPO_DIR
cd $REPO_DIR

if ! gh auth status; then
    gh auth login
fi

gh_owner=$(git_owner $origin)
gh_name=$(git_name $origin)

if [ -z "$gh_owner" ] || [ -z "$gh_name" ]; then
    warn Invalid git url: $origin
    exit 1
fi

: ${gh_description:="Getupcloud Managed Cluster: $customer"}
: ${gh_team:=developers}
: ${gh_enable_wiki:=false}
: ${gh_enable_issues:=false}

if ! gh api orgs/$gh_owner/teams/$gh_team &>/dev/null; then
    gh_team=""
fi

if ! PAGER= gh api repos/$gh_owner/$gh_name &>/dev/null; then
    ask "Create repository $gh_owner/$gh_name now? [Y/n]"
    # repo doesn't exists, create now
    # origin will be added by `gh`
    gh repo create $gh_owner/$gh_name \
        --confirm \
        --private=true \
        ${gh_team:+--team=$gh_team} \
        --description="${gh_description}" \
        --enable-issues=${gh_enable_issues} \
        --enable-wiki=${gh_enable_wiki}
fi

# upload flux ssh deploy key
#info Checking ssh key
local_ssh_key_fingerprint=$(ssh-keygen -l -E sha256 -f $CLUSTER_DIR/identity.pub | awk '{print $2}')
remote_ssh_key_fingerprints=(
  $(PAGER= gh api repos/$gh_owner/$gh_name/keys | jq '.[]|.key' -r | ssh-keygen -l -E sha256 -f - | awk '{print $2}')
)

found=false
if [ ${#remote_ssh_key_fingerprints[*]} -gt 0 ]; then
  for fp in ${remote_ssh_key_fingerprints[*]}; do
    if [ "$fp" == "$local_ssh_key_fingerprint" ]; then
      found=true
      break
    fi
  done
fi

if $found; then
  info "Ssh key $CLUSTER_DIR/identity.pub ($local_ssh_key_fingerprint) already registered at repo $origin"
else
  info "Uploading ssh key: $CLUSTER_DIR/identity.pub ($local_ssh_key_fingerprint)"

  if ! PAGER= gh api repos/$gh_owner/$gh_name/keys \
      -f "key=$(<$CLUSTER_DIR/identity.pub)" -f read_only=false -f title="managed-cluster-${name}-${type}"; then
          warn "Failed adding key"
  fi
fi
